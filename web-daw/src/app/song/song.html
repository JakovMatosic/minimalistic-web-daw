<div class="song-container p-4 bg-gray-950 text-gray-200 min-h-screen" (click)="onUserInteraction()">
  <div class="controls flex gap-4 mb-4 items-center">


    <!-- Octave Range Controls -->

    <!-- Key / Scale Controls -->
    <label>
      Key:
      <select [(ngModel)]="rootKey" (change)="onKeyOrScaleChange()"
        class="bg-gray-800 border border-gray-700 p-1 rounded">
        <option *ngFor="let key of keys; trackBy: trackByKey" [value]="key.value">
          {{ key.label }}
        </option>
      </select>
    </label>

    <label>
      Scale:
      <select [(ngModel)]="scale" (change)="onKeyOrScaleChange()"
        class="bg-gray-800 border border-gray-700 p-1 rounded">
        <option *ngFor="let scale of scaleTypes; trackBy: trackByScale" [value]="scale">
          {{ scale }}
        </option>
      </select>
    </label>


    <label>
      Lowest Octave:
      <select [(ngModel)]="pianoRollMinOctave" (change)="updatePianoRollOctaves()"
        class="bg-gray-800 border border-gray-700 p-1 rounded">
        <option *ngFor="let oct of [2, 3, 4, 5, 6, 7]" [value]="oct">
          {{ oct }}
        </option>
      </select>
    </label>

    <label>
      Highest Octave:
      <select [(ngModel)]="pianoRollMaxOctave" (change)="updatePianoRollOctaves()"
        class="bg-gray-800 border border-gray-700 p-1 rounded">
        <option *ngFor="let oct of [2, 3, 4, 5, 6, 7]" [value]="oct">
          {{ oct }}
        </option>
      </select>
    </label>

    <!-- ...existing controls... -->
    <label>
      Instrument:
      <select [(ngModel)]="currentInstrumentId" (change)="handleInstrumentChange($event)"
        class="bg-gray-800 border border-gray-700 p-1 rounded">
        <option *ngFor="let inst of instruments; trackBy: trackByInstrumentId" [value]="inst.id">
          {{ inst.name }}
        </option>
      </select>

    </label>

    <button class="bg-blue-700 hover:bg-blue-600 px-2 py-1 rounded text-sm" (click)="showInstrumentPopup = true">
      + Add Instrument
    </button>

    <button class="bg-red-700 hover:bg-red-600 px-2 py-1 rounded text-sm" (click)="deleteCurrentInstrument()">
      üóë Delete Instrument
    </button>

    <!-- Instrument Type Popup -->
    <div *ngIf="showInstrumentPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-gray-900 p-6 rounded shadow-lg flex flex-col gap-2 min-w-[240px]">
        <div class="text-lg font-semibold mb-2">Choose Instrument Type</div>

        <button *ngFor="let type of instrumentTypes" class="bg-blue-600 hover:bg-blue-500 px-3 py-2 rounded text-white"
          (click)="addInstrument(type); showInstrumentPopup = false">
          {{ INSTRUMENT_LABELS[type] }}
        </button>

        <button class="mt-2 text-gray-400 hover:text-gray-200" (click)="showInstrumentPopup = false">
          Cancel
        </button>
      </div>
    </div>

    <label>
      Pattern:
      <select [(ngModel)]="currentPatternId" (change)="handlePatternChange($event)"
        class="bg-gray-800 border border-gray-700 p-1 rounded">
        <option *ngFor="let p of currentInstrument.patterns; trackBy: trackByPatternId" [value]="p.id">
          {{ truncatePatternName(p.name) }}
        </option>
      </select>
    </label>

    <button class="bg-green-700 hover:bg-green-600 px-2 py-1 rounded text-sm" (click)="addPattern()">
      + New Pattern
    </button>

    <button class="bg-red-700 hover:bg-red-600 px-2 py-1 rounded text-sm" (click)="deleteCurrentPattern()">
      üóë Delete Pattern
    </button>

    <button class="px-2 py-1 rounded text-sm" [class.bg-yellow-700]="!isPrimed" [class.bg-green-700]="isPrimed"
      [class.hover:bg-yellow-600]="!isPrimed" [class.hover:bg-green-600]="isPrimed" [disabled]="isPriming"
      (click)="prime()">
      {{ isPriming ? '‚è≥ Priming...' : (isPrimed ? '‚úì Primed' : '‚ö° Prime') }}
    </button>
  </div>

  <app-piano-roll [track]="currentPattern.track" [minOctave]="pianoRollMinOctave" [maxOctave]="pianoRollMaxOctave"
    (ngModelChange)="saveToStorage()" [rootKey]="rootKey" [scale]="scale">
  </app-piano-roll>

  <app-playback [bpm]="bpm" [isPlaying]="isPlaying" [instruments]="instruments" (bpmChange)="bpm = $event"
    (togglePlay)="togglePlay()" (sequenceChange)="onSequenceChange($event)">
  </app-playback>

  <app-instrument-settings-bar [instruments]="instruments" (openSettings)="openInstrumentSettings($event)"
    (settingsChange)="onInstrumentSettingsChange()"></app-instrument-settings-bar>
</div>